<!DOCTYPE html>
<html lang="en">
<head>

  <!-- Basic Page Needs
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta charset="utf-8">
  <title>Cloudinary - Azure Video Indexer AddOn - Video Insights</title>
  <meta name="description" content="">
  <meta name="author" content="">

  <!-- Mobile Specific Metas
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- CSS
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <link href="https://unpkg.com/cloudinary-video-player@1.9.4/dist/cld-video-player.min.css" rel="stylesheet">
  <link href="./css/video-insights-shell.css" rel="stylesheet">
</head>
<body>

  <!-- Primary Page Layout
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <div class="container">
    <div class="row" style="margin-top: 20px;">
      <div class="col-6">
        <video 
          id="cld-player" 
          controls
          muted
          class="cld-video-player"
          style="width:100%">
      </div>
      <div class="col-6">
        <nav>
          <div class="nav nav-tabs" id="insights-tabs" role="tablist">
            <button id="nav-ocr-tab" class="nav-link active" type="button" role="tab" 
              data-bs-toggle="tab" 
              data-bs-target="#nav-ocr" 
              aria-controls="nav-ocr" 
              aria-selected="true">ocr</button>
            <button id="nav-keywords-tab" class="nav-link" type="button" role="tab" 
              data-bs-toggle="tab" 
              data-bs-target="#nav-keywords" 
              aria-controls="nav-keywords" 
              aria-selected="false">keywords</button>
            <button id="nav-topics-tab" class="nav-link" type="button" role="tab" 
              data-bs-toggle="tab" 
              data-bs-target="#nav-topics" 
              aria-controls="nav-topics" 
              aria-selected="false">topics</button>
            <button id="nav-faces-tab" class="nav-link" type="button" role="tab" 
              data-bs-toggle="tab" 
              data-bs-target="#nav-faces" 
              aria-controls="nav-faces" 
              aria-selected="false">faces</button>
            <button id="nav-labels-tab" class="nav-link" type="button" role="tab" 
              data-bs-toggle="tab" 
              data-bs-target="#nav-labels" 
              aria-controls="nav-labels" 
              aria-selected="false">labels</button>
            <button id="nav-namedPeople-tab" class="nav-link" type="button" role="tab" 
              data-bs-toggle="tab" 
              data-bs-target="#nav-namedPeople" 
              aria-controls="nav-namedPeople" 
              aria-selected="false">namedPeople</button>
          </div>
        </nav>
        <div class="tab-content" id="nav-tabContent">
          <div id="nav-ocr" role="tabpanel" class="tab-pane fade show active" 
            aria-labelledby="nav-ocr-tab"></div>
          <div id="nav-keywords" role="tabpanel" class="tab-pane fade" 
            aria-labelledby="nav-keywords-tab"></div>
          <div id="nav-topics" role="tabpanel" class="tab-pane fade" 
            aria-labelledby="nav-topics-tab"></div>
          <div id="nav-faces" role="tabpanel" class="tab-pane fade" 
            aria-labelledby="nav-faces-tab"></div>
          <div id="nav-labels" role="tabpanel" class="tab-pane fade" 
            aria-labelledby="nav-labels-tab"></div>
          <div id="nav-namedPeople" role="tabpanel" class="tab-pane fade" 
            aria-labelledby="nav-namedPeople-tab"></div>
        </div>        
      </div>
    </div>
  </div>

<!-- End Document
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->

<!-- Scripts
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
<script src="https://code.jquery.com/jquery-3.6.1.min.js" 
  integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" 
  crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" 
  integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" 
  crossorigin="anonymous">
</script>
<script src="https://unpkg.com/cloudinary-video-player@1.9.4/dist/cld-video-player.min.js" 
  type="text/javascript"></script>
<script src="./js/jquery.mustache.js" 
  type="text/javascript"></script>
<script type="text/javascript">
  // Reading query string parameters via Proxy over URLSearchParams 
  const QsParams = new Proxy(new URLSearchParams(window.location.search), {
    get: (searchParams, prop) => searchParams.get(prop),
  });

  __cld_video_player = null;

  $(document).ready(async function(){
    const cloud_name = QsParams.c;
    const asset_data_url = QsParams.a;
    console.log(`cloud: ${cloud_name}`);
    console.log(`asset: ${asset_data_url}`);
    console.log('Loading asset data...');
    const resp = await fetch(asset_data_url);
    const asset_data = await resp.json();
    console.log(`Done`);

    const asset_pubid = asset_data.public_id;
    console.log(`Resolved video asset public id to '${asset_pubid}'`);

    console.log('Initializing Cloudinary Video Player...');
    __cld_video_player = cloudinary.videoPlayer('cld-player', { 
      cloud_name: cloud_name,
      bigPlayButton: 'init' });
    __cld_video_player.source(asset_pubid);
    console.log('Done')

    console.log('Adjusting height for the insights list area');
    viewportHeight = window.innerHeight;
    tabsNav = $('#insights-tabs');
    topOffset = tabsNav.offset().top + tabsNav.height();
    maxHeight = viewportHeight - topOffset - 10;
    $('#nav-tabContent').css({"max-height": maxHeight, "overflow-y": "scroll"});
    console.log('Done');

    insights = asset_data.info.multiple.azure_video_indexer.data['en-US'];
    console.log('Visualizing insights...');
    visualizeInsightsCategory({
      category_insights    : insights.ocr,
      entity_label_field   : 'text',
      confidence_on_entity : true,
      use_instance_source  : false,
      dest_ui_element_id   : 'nav-ocr'
    });
    visualizeInsightsCategory({
      category_insights    : insights.keywords,
      entity_label_field   : 'text',
      confidence_on_entity : true,
      use_instance_source  : false,
      dest_ui_element_id   : 'nav-keywords'
    });
    visualizeInsightsCategory({
      category_insights    : insights.topics,
      entity_label_field   : 'name',
      confidence_on_entity : true,
      use_instance_source  : false,
      dest_ui_element_id   : 'nav-topics'
    });
    visualizeInsightsCategory({
      category_insights    : insights.faces,
      entity_label_field   : 'name',
      confidence_on_entity : true,
      use_instance_source  : false,
      dest_ui_element_id   : 'nav-faces'
    });
    visualizeInsightsCategory({
      category_insights    : insights.labels,
      entity_label_field   : 'name',
      confidence_on_entity : false,
      use_instance_source  : false,
      dest_ui_element_id   : 'nav-labels'
    });
    visualizeInsightsCategory({
      category_insights    : insights.namedPeople,
      entity_label_field   : 'name',
      confidence_on_entity : true,
      use_instance_source  : true,
      dest_ui_element_id   : 'nav-namedPeople'
    });
    console.log('Done');
  });

  /**
   * Manipulates Cloudinary Video Player instance on the page
   * to navigate to a specific time code. 
   * 
   * - timeOffsetLabel (string) -- time offset 'h:mm:ss.ff' from Video Indexer insights
   */
  function setVideoPlayerCurrentTime(timeOffsetLabel) {
    const segm = timeOffsetLabel.split(':');
    const h_offset = parseInt(segm[0]) * 3600;
    const m_offset = parseInt(segm[1]) * 60;
    const s_offset = parseFloat(segm[2]);

    const offsetSeconds= Number(h_offset) + Number(m_offset) + Number(s_offset);
    console.log(`Setting video player current time [${timeOffsetLabel}] > [${offsetSeconds}]`);
    __cld_video_player.currentTime(offsetSeconds);
    __cld_video_player.play();  // Using play-pause for the offset to take effect 
    __cld_video_player.pause(); //   when used for the first time (otherwise player stays on the thumbnail)
  }


  /**
   * Translates Azure Video Indexer insights into UI (category > entity > time codes).
   * UI events are used to manipulate Cloudinary Video Player instance on the page
   * to navigate to each individual time code. 
   *
   * config structure:
   * {
   *   category_insights    : (Array)   -- Azure Video Indexer insights data for the category
   *   entity_label_field   : (string)  -- field name to use as display name for each record from the insights
   *   confidence_on_entity : (bool)    -- whether to read confidence value from entity or instances
   *   use_instance_source  : (bool)    -- some entities may specify the source of the insight. Controls whether to read it
   *   dest_ui_element_id   : (string)  -- id of the HTML element to translate the category insights into
   * } 
   */
  function visualizeInsightsCategory(config) {
    const rootUiContainer = $('#'+config.dest_ui_element_id);
    const destContId = config.dest_ui_element_id + "-accordion"
    const destUIContainer = $(`<div id=${destContId} class="accordion accordion-flush"></div>`);
    rootUiContainer.append(destUIContainer);

    let _index = 1;
    for (const insight of config.category_insights) {
      insightUI = visualizeInsight({
        insight              : insight,
        index                : _index,
        ui_container_id      : destContId,
        entity_label_field   : config.entity_label_field,
        confidence_on_entity : config.confidence_on_entity,
        use_instance_source  : config.use_instance_source
      });
      destUIContainer.append(insightUI);
      _index += 1;
    }
  }

  /**
   * Translates a single Azure Video Indexer insight into UI element
   *
   * config structure:
   * {
   *   index                : (int)     -- Used to differentiate dynamic HTML elements
   *   insight              : (Object)  -- Azure Video Indexer insight data
   *   ui_container_id      : (string)  -- id of the UI HTML container
   *   entity_label_field   : (string)  -- field name to use as display name for each record from the insights
   *   confidence_on_entity : (bool)    -- whether to read confidence value from entity or instances
   *   use_instance_source  : (bool)    -- some entities may specify the source of the insight. Controls whether to read it
   * }
   * 
   * returns (Object)                   -- jQuery object with the new UI element
   */
  function visualizeInsight(config) {
    const insight = config.insight;
    const label = insight[config.entity_label_field];
    const insightConfidence = config.confidence_on_entity ? insight.confidence : null;

    // Model for the az-video-indexer-insight-template Mustache template
    //   defined below
    const model = {
      categoryInsightsContainerId: config.ui_container_id,
      collapseHeaderId: "cHdr" + config.index,
      collapseSectionId: 'cSec' + config.index,
      headerText: label,
      timecodes: [] //offset, label
    }

    for (let instance of insight.instances) {
      const source = config.use_instance_source ? instance.instanceSource : null;
      const instanceConfidence = insightConfidence ? insightConfidence : instance.confidence;

      const confidenceLabel = (parseFloat(instanceConfidence)*100).toFixed(1) + '%';
      let timestampContext = ['[🤔', confidenceLabel];
      if (source) {
        timestampContext.push(`, ${source}👀`);
      }
      timestampContext.push(']')
      contextLabel = timestampContext.join('');

      model.timecodes.push({offset: instance.start, label: contextLabel});
    }

    const insightTmpl = $('#az-video-indexer-insight-template').text();
    const uiMarkup = $.mustache(insightTmpl, model);

    return $(uiMarkup, // data - HTML produced from the template
      document,        // context - default
      true);           // keepScripts
  }
</script>

<!-- Mustache.JS templates
–––––––––––––––––––––––––––––––––––––––––––––––––– -->
<noscript id="az-video-indexer-insight-template" type="text/html">
  <div class="accordion-item">
    <h2 class="accordion-header" id="{{collapseHeaderId}}">
      <button class="accordion-button collapsed" type="button" 
        data-bs-toggle="collapse" 
        data-bs-target="#{{collapseSectionId}}" 
        aria-expanded="false" 
        aria-controls="flush-collapseOne">
        {{headerText}}
      </button>
    </h2>
    <div id="{{collapseSectionId}}" class="accordion-collapse collapse" 
      aria-labelledby="{{collapseHeaderId}}" 
      data-bs-parent="#{{categoryInsightsContainerId}}">
      <div class="accordion-body">
        {{#timecodes}}
        <div class="timestamp">
          <a href="#" onclick="setVideoPlayerCurrentTime('{{offset}}');return false;">
            {{offset}}
          </a>{{label}}</div>
        {{/timecodes}}
      </div>
    </div>
  </div>
</noscript>
</body>
</html>

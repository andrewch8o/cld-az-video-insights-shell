<!DOCTYPE html>
<html lang="en">
<head>

  <!-- Basic Page Needs
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta charset="utf-8">
  <title>Cloudinary - Azure Video Indexer AddOn - Video Insights</title>
  <meta name="description" content="">
  <meta name="author" content="">

  <!-- Mobile Specific Metas
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- CSS
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <link href="https://unpkg.com/cloudinary-video-player@1.9.4/dist/cld-video-player.min.css" rel="stylesheet">
  <link href="./css/video-insights-shell.css" rel="stylesheet">
</head>
<body>

  <!-- Primary Page Layout
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <div class="container">
    <div class="row" style="margin-top: 20px;">
      <div class="col-6">
        <video 
          id="cld-player" 
          controls
          muted
          class="cld-video-player"
          style="width:100%">
      </div>
      <div class="col-6">
        <nav>
          <div class="nav nav-tabs" id="insights-tabs" role="tablist">
            <!-- Navigation tabs for each category of insights are dynamically created here -->
          </div>
        </nav>
        <div class="tab-content" id="insights-content">
          <!-- Content areas for each category of insights are dynamically created here -->
        </div>        
      </div>
    </div>
  </div>

<!-- End Document
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->

<!-- Scripts
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
<script src="https://code.jquery.com/jquery-3.6.1.min.js" 
  integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" 
  crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" 
  integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" 
  crossorigin="anonymous">
</script>
<script src="https://unpkg.com/cloudinary-video-player@1.9.4/dist/cld-video-player.min.js" 
  type="text/javascript"></script>
<script src="./js/jquery.mustache.js" 
  type="text/javascript"></script>
<script type="text/javascript" id="globals">
  // Reading query string parameters via Proxy over URLSearchParams 
    const QsParams = new Proxy(new URLSearchParams(window.location.search), {
    get: (searchParams, prop) => searchParams.get(prop),
  });

  __cld_video_player = null;

  /**
   * Model that describes all the insight categories (sections) from Azure Video Indexer JSON.  
   *
   * Each element is expected to have the following structure
   * 
   * {
   *  dataSelector      (string) -- section data selector (in Video Indexer JSON)
   *                                Also used to dynamically construct id(s) for UI HTML elements
   *  uiBaseId,         (string) -- id to be used to differentiate UI elements
   *  title,            (string) -- title to be used for the tab header
   *  cssState,         (string) -- 'active' (if tab should be selected when rendered). 
   *                                "Falsy" otherwise
   *  insights,         (Array)  -- used to build UI model from the Azure Video Indexer JSON
   *                                Created dynamically during execution from Video Indexer JSON
   *  dataToModelConf { (Object) -- configuration used when transforming Video Indexer JSON to UI model
   *    labelField                  (string) -- which field value to use as the label for the insight in the UI
   *  }
   * 
   * Insights
   * Each insight model is expected to have the following structure
   * {
   *    label,               (string) -- display label for the insight in the UI
   *    confLabel,           (string) -- label for the confidence level reported by AI 
   *    collapse {           (Object) -- configuration for the collapse section in accordion UI
   *      hId,               (string) -- collapse section header id
   *      sId,               (string) -- collapse section body id
   *    },    
   *    timecodes: [         (Array)  -- list of timecodes from entity instances reported by Video Indexer
   *        {
   *           rawVal,       (string) -- time code raw value, preserves fraction of a second (to be passed to player)
   *           displayVal,   (string) -- to be used as display value for time code (for consistent display)
   *           label         (string) -- additional information for time code to be displayed in UI
   *        }
   *    ]
   * }
   */
  __cld_video_indexer_sections_model = [
    {
      dataSelector: 'ocr',
      uiBaseId:     'ocr',
      title:        'OCR',
      cssState:     'active',
      dataToModelConf : {
        labelField: 'text'
      }
    },
    {
      dataSelector: 'keywords',
      uiBaseId:     'keywords',
      title:        'Keywords',
      dataToModelConf : {
        labelField: 'text'
      }
    },
    {
      dataSelector: 'topics',
      uiBaseId:     'topics',
      title:        'Topics',
      dataToModelConf : {
        labelField: 'name'
      }
    },
    {
      dataSelector: 'faces',
      uiBaseId:     'faces',
      title:        'Faces',
      dataToModelConf : {
        labelField: 'name'
      }
    },
    {
      dataSelector: 'labels',
      uiBaseId:     'labels',
      title:        'Labels',
      dataToModelConf : {
        labelField: 'name'
      }
    },
    {
      dataSelector: 'scenes',
      uiBaseId:     'scenes',
      title:        'Scenes',
      dataToModelConf : {
        labelField: 'id'
      }
    },
    {
      dataSelector: 'namedPeople',
      uiBaseId:     'namedPeople',
      title:        'Named People',
      dataToModelConf : {
        labelField: 'name'
      }
    }
  ]
</script>
<script type="text/javascript" id="ui-event-handler-scripts">
    /**
   * Manipulates Cloudinary Video Player instance on the page
   * to navigate to a specific time code. 
   * 
   * - timeOffsetLabel (string) -- time offset 'h:mm:ss.ff' from Video Indexer insights
   */
   function setVideoPlayerCurrentTime(timeOffsetLabel) {
    const segm = timeOffsetLabel.split(':');
    const h_offset = parseInt(segm[0]) * 3600;
    const m_offset = parseInt(segm[1]) * 60;
    const s_offset = parseFloat(segm[2]);

    const offsetSeconds= Number(h_offset) + Number(m_offset) + Number(s_offset);
    console.log(`Setting video player current time [${timeOffsetLabel}] > [${offsetSeconds}]`);
    __cld_video_player.currentTime(offsetSeconds);
    __cld_video_player.play();  // Using play-pause for the offset to take effect 
    __cld_video_player.pause(); //   when used for the first time (otherwise player stays on the thumbnail)
  }

  /**
   * Implements "sticky behavior" for expanded accordion sections.
   * Adds/Removes 'sticky' css class.
   * CSS is used for the in-browser behavior.
   */
  function ensureAccordionSectionStickyWhenExpanded(elementId) {
    const domId = '#' + elementId
    const accordionSectionHdr = $(domId);
    console.log(`Applying sticky behavior to accordion header ${domId}`);
    const accordionBtn = $('button.accordion-button', accordionSectionHdr);
    const accordionSectionExpanded = accordionBtn.attr('aria-expanded');
    if (accordionSectionExpanded === 'true') {
      accordionSectionHdr.addClass('sticky')
    } else {
      accordionSectionHdr.removeClass('sticky');
    }
  }
</script>
<script type="text/javascript" id="shell-ui-scripts">
  $(document).ready(async function(){
    const cloud_name = QsParams.c;
    const asset_data_url = QsParams.a;
    console.log(`cloud: ${cloud_name}`);
    console.log(`asset: ${asset_data_url}`);
    console.log('Loading asset data...');
    const resp = await fetch(asset_data_url);
    const asset_data = await resp.json();
    console.log(`Done`);

    const asset_pubid = asset_data.public_id;
    console.log(`Resolved video asset public id to '${asset_pubid}'`);

    console.log('Initializing Cloudinary Video Player...');
    __cld_video_player = cloudinary.videoPlayer('cld-player', { 
      cloud_name: cloud_name,
      bigPlayButton: 'init' });
    __cld_video_player.source(asset_pubid);
    console.log('Done')

    console.log('Adjusting height for the insights list area');
    viewportHeight = window.innerHeight;
    tabsNav = $('#insights-tabs');
    topOffset = tabsNav.offset().top + tabsNav.height();
    maxHeight = viewportHeight - topOffset - 10;
    $('#nav-tabContent').css({"max-height": maxHeight, "overflow-y": "scroll"});
    console.log('Done');

    console.log('Visualizing insights...');
    insights = asset_data.info.multiple.azure_video_indexer.data['en-US'];
    visualizeInsights({
      model: __cld_video_indexer_sections_model,
      input: insights
    });
    console.log('Done');
  });

  /**
   * Visualizes Video Indexer insights to the HTML shell UI
   * 
   * config: {
   *   model     (Object) -- see the `__cld_video_indexer_sections_model` docstring
   *   input     (Object) -- parsed Video Indexer JSON insights
   * }
   * 
   */
  function visualizeInsights(config) {
    expandModelFromInput(config);

    for (const section of config.model) {
      const tabhdrTmpl = $('#az-video-indexer-category-tabheader-template').text();
      const tabhdrMarkup = $.mustache(tabhdrTmpl, section);
      const tabHdr = $.parseHTML(
        tabhdrMarkup, // data - HTML produced from the template
        document,     // context - default
        false);       // don't keepScripts
      $('#insights-tabs').append(tabHdr);

      const contentTmpl = $('#az-video-indexer-category-tabcontent-template').text();
      const contentMarkup = $.mustache(contentTmpl, section);
      const tabContent = $.parseHTML(
        contentMarkup,// data - HTML produced from the template
        document,     // context - default
        true);        // keepScripts to enable in-template JS event handlers
      $('#insights-content').append(tabContent);
    }
  }

  /**
   * Expands model data from the Video Indexer input
   * 
   * config - see the visualizeInsights docstring
   */
  function expandModelFromInput(config) {
    for (const sectionModel of config.model) {
      const sectionData = config.input[sectionModel.dataSelector];
      sectionModel.insights = getInsightsModel(sectionModel, sectionData);
    }
  }

  /**
   * Builds model for Video Indexer section insights.
   * 
   * sectionModel  (Object) --  model for the section to be processed
   * sectionData   (Object) --  section data from Video Indexer JSON
   * 
   * Returns insights model value to be used with HTML templates 
   */
  function getInsightsModel(sectionModel, sectionData) {
      const result = [];
      const labelFld = sectionModel.dataToModelConf.labelField;
      let index = 0;
      for (const insightData of sectionData) {
        const insight = {};
        insight.label = insightData[labelFld];
        insight.confLabel = "";
        if (insightData.hasOwnProperty('confidence')) {
          const displayVal = (parseFloat(insightData.confidence)*100).toFixed(1) + '%';
          insight.confLabel = `🤔${displayVal}`;
        }
        insight.collapse = {
          hId : `${sectionModel.uiBaseId}-chdr-${index}`,
          sId : `${sectionModel.uiBaseId}-csec-${index}`
        }
        insight.timecodes = getInsightTimecodesModel(insightData.instances);
        result.push(insight);
        index += 1;
      }
      return result;
  }

  /**
   * Within an insight model builds models for time codes.
   * Time codes contain information about points in time when insight is present in the video.
   * 
   * instances  (Array) -- list of insight instances from Video Indexer JSON
   * 
   * Returns timecodes model value for an insight
   */
  function getInsightTimecodesModel(instances) {
    const result = [];
    for (const rec of instances) {
      const timecode = {};
      timecode.rawVal = rec.start;
      timecode.displayVal = rec.start;
      timecode.label = "";
      if (rec.hasOwnProperty('confidence')) {
        const confidenceLabel = (parseFloat(rec.confidence)*100).toFixed(1) + '%';
        timecode.label = `🤔${confidenceLabel}`;
      }
      if (rec.hasOwnProperty('instanceSource')) {
        if (timecode.label.length > 0) {
          timecode.label += ', ';  
        }
        timecode.label += `${rec.instanceSource}👀`
      }
      result.push(timecode);
    }
    return result;
  }
</script>

<!-- Mustache.JS templates
–––––––––––––––––––––––––––––––––––––––––––––––––– -->
<!-- 
  Categories are visualized using Bootstrap tabs.
  https://getbootstrap.com/docs/5.0/components/navs-tabs/#tabs

  Each tab requires two elements in separate containers - tab header and tab content area.
  This is tab header.

  The template is designed to work with elements in the `__cld_video_indexer_sections_model` model,
  see the model docstring
-->
<noscript id="az-video-indexer-category-tabheader-template" type="text/html">
  <button id="{{uiBaseId}}-tabhdr" class="nav-link {{cssState}}" type="button" role="tab" 
    data-bs-toggle="tab"
    data-bs-target="#{{uiBaseId}}-tabcontent" 
    aria-controls="{{uiBaseId}}-tabcontent" 
    aria-selected="true">{{title}}</button>
</noscript>

<!-- 
  Categories are visualized using Bootstrap tabs.
  Each tab requires two elements in separate containers - tab header and tab content area.
  This is tab content area.

  The template is designed to work with elements in the `__cld_video_indexer_sections_model` model,
  see the model docstring
-->
<noscript id="az-video-indexer-category-tabcontent-template" type="text/html">
  <div id="{{uiBaseId}}-tabcontent" role="tabpanel" class="tab-pane {{cssState}}" 
    aria-labelledby="{{uiBaseId}}-tabhdr">
    <div class="accordion accordion-flush" id="{{uiBaseId}}-accordion">
      {{#insights}}
      <div class="accordion-item">
        <h2 class="accordion-header" id="{{collapse.hId}}" 
          onclick="ensureAccordionSectionStickyWhenExpanded(this.id); return false;">
          <button class="accordion-button collapsed" type="button" 
            data-bs-toggle="collapse" 
            data-bs-target="#{{collapse.sId}}" 
            aria-expanded="false" 
            aria-controls="{{collapse.sId}}">
            <div class="container">
              <div class="row">
                <div class="col-9">{{label}}</div>
                <div class="col-3">{{confLabel}}</div>
              </div>
            </div>
          </button>
        </h2>
        <div id="{{collapse.sId}}" class="accordion-collapse collapse" 
          aria-labelledby="{{collapse.hId}}" 
          data-bs-parent="#{{uiBaseId}}-accordion">
          <div class="accordion-body">
            <div class="container">
            {{#timecodes}}
              <div class="row">
                <div class="col-4">
                  <a href="#" onclick="setVideoPlayerCurrentTime('{{rawVal}}');return false;">
                    {{displayVal}}
                  </a>
                </div>
                <div class="col-8">{{label}}</div>
              </div>
            {{/timecodes}}
            </div>
          </div>
        </div>
      </div>
      {{/insights}}
    </div>
  </div>
</noscript>

</body>
</html>
